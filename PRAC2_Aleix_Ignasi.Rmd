---
title: 'Pràctica 2: Neteja i validació de dades'
author: "Aleix Martínez Bages i Ignasi Vilarasau Antolin"
date: "10/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1 Descripció del Dataset
En aquest projecte treballarem sobre un conjunt de dades extret de Kaggle[^1] que conté informació relativa a tots els llençaments fets en partits de la NBA al llarg de la temporada 2014-2015. L'objectiu de l'estudi és determinar els factors que influencien l'encert del llençament, com la distància a la canasta o el temps de jocs. La finalitat és coneixer en quines situacions tenim més probabilitats d'anotar coneixent les característiques del moment.

[^1]:enllaç: https://www.kaggle.com/dansbecker/nba-shot-logs

El dataset conté 128.060 observacions de 28 variables diferents que presentem a continuació:

  * **GAME_ID**: Identificador del partit
  * **MATCHUP**: Data del partit i noms dels equips local vs visitant
  * **LOCATION**: Si es va jugar a casa o fora; A = away, H = home
  * **W**: Si l'equip local guanya o perd; W = win, L = lose
  * **FINAL_MARGIN**: Diferència de punts del resultat final.
  * **SHOT_NUMBER**: Quants llençaments portava el moment de fer l'acció.
  * **PERIOD**: Periode del partit en el que s'efectua el llençament.
  * **GAME_CLOCK**: Temps que queda per acabar al moment del tir.
  * **SHOT_CLOCK**: Segon de la posseció de la jugada (max 24 segons)
  * **DRIBBLES**: Dribblings fets pel jugador amb la pilota
  * **TOUCH_TIME**: Temps que el jugador ha tingut la pilota a les mans
  * **SHOT_DIST**: Distància desde la qual llença el jugador
  * **PTS_TYPE**: Tipus de llençament si de 2 o 3 punts (triple)
  * **SHOT_RESULT**: Si ha encertat (made) o fallat (missed) el llençament 
  * **CLOSEST_DEFENDER**: Nom del defensor més proper
  * **CLOSEST_DEFENDER_PLAYER_ID**: Id del defensor més proper
  * **CLOSE_DEF_DIST**: Distància amb el defensa més proper
  * **FGM**: Variable binària (0,1) indicant si ha encertat o fallat el tir
  * **PTS**: Punts aconseguits amb el llençament
  * **player_name**: Nom del jugador que efectua el tir
  * **player_id**: ID del jugador que efectua el tir
 



```{r echo = FALSE, include = FALSE}
library(readr)
library(magrittr)
library(ggplot2)
library(dplyr)
```

El primer pas és llegir el fitxer on tenim les dades guardades, aquestes es troben en un format CSV. 
```{r}
data <- read_csv("shot_logs.csv")
head(data[,1:10])
```

# 2  Neteja de les dades

## 2.1 Comprovació NA
Comprovem la presència de valors nuls en el conjunt de dades per saber per on començar la neteja.
```{r}
sapply(data, function(x) sum(is.na(x)))
```
Per sort, l'únic camp amb presència de valors nuls és el SHOT_CLOCK.

## 2.2 Neteja del SHOT_CLOCK

### 2.2.1 Valors NA

En SHOT_CLOCK és l'únic camp on tenim presència de valors nuls. Hem observat que la majoria de NA del SHOT_CLOCK apareixen quan el temps del periode és inferior als 24 segons de poseció que té permès l'equip. Per això, assignarem al SHOT_CLOCK els segons del temps de joc restant. 
```{r}
head(data[is.na(data$SHOT_CLOCK), c("SHOT_CLOCK","GAME_CLOCK")])
```


Extreiem els minuts i segons del rellotge de partit, per tenir el temps de joc restant.
```{r}
strp_GC <- strptime(data$GAME_CLOCK, '%M:%S')
data$GAME_CLOCK_MIN <- as.numeric(strp_GC$min)
data$GAME_CLOCK_SEC <- as.numeric(strp_GC$sec)
```

Posem el temps de partit com a SHOT_CLOCK per aquells valors NA.
```{r}
data$SHOT_CLOCK <- ifelse(is.na(data$SHOT_CLOCK),  data$GAME_CLOCK_SEC, data$SHOT_CLOCK)
```


### 2.2.2 Correció valors
Hem vist la presència de valors de possessió superiors als 24 segons, cosa que no està permesa segons el reglament. Per solventar aquest problema, assignarem el temps màxim de possessió permesa (24) com a valors per aquests casos.
```{r}
data$SHOT_CLOCK[data$SHOT_CLOCK > 24] <- 24
```

## 2.3 Neteja del TOUCH_TIME
Hem observat la presència de TOUCH_TIME negatiu, cosa que no té sentit, ja que el temps de possessió ha de ser sempre positiu.
```{r}
sum(data$TOUCH_TIME <0)
```
Per solucionar aquest 312 registres incorrectes agafarem el valor absolut perquè considerem que és fruit d'una errada. De la meteixa manera que els valor de SHOT_CLOCK superiors a 24, assignarem aquests valors als TOUCH_TIME superiors a 24 segons.
```{r}
data$TOUCH_TIME <- abs(data$TOUCH_TIME)
data$TOUCH_TIME[data$TOUCH_TIME > 24] <- 24
```

## 2.4 Categorització distàncies
A continuació categoritzarem els atributs numèrics corresponents a la distància de llençament i la distancia del defensor.

### 2.4.1 Conversió distàncies
El primer pas es convertir les distàncies a sistema mètric. Les nostres dades estan en el sistema nord-americà on 1 peu son 0.308 metres.
```{r}
feet_to_metre <- 0.3048
data$SHOT_DIST <- feet_to_metre*data$SHOT_DIST
data$CLOSE_DEF_DIST <- feet_to_metre*data$CLOSE_DEF_DIST
```

### 2.4.2 Comprovació distàncies
La zona de triples comença a una distància de 7.3 metres, per tant no hi ha d'haver tirs de dos de distàncies superiors. De la mateixa manera, la distància mínima a canasta és de 6.7 metres i no hi ha d'haver tirs de 3 a menor distància.
```{r}
data$PTS_TYPE[data$SHOT_DIST > 7.3] <- 3
data$PTS_TYPE[data$SHOT_DIST < 6.7] <- 2
```

### 2.4.3 Categoritzar distància de llençament
Categoritzem la distància de llençament en tres grups per així veure com afecta la distància en el llençament.Les nostres categories són entre 0 i  2.8m serà *Close Distance(C)*, entre 2.8m i 6.4m  *Medium Distance (M)*, i més de 6.4m per *Far Distance (F)*. En l'última categoria entrarien tots els llençaments de triples.
```{r}
data$SHOT_DIST_C <- "M"
data$SHOT_DIST_C[data$SHOT_DIST < 2.8] <- "C" 
data$SHOT_DIST_C[data$SHOT_DIST > 6.4] <- "F"
```

### 2.4.4 Categoritzar distància defensor.
De la mateixa manera que amb la distància de llençament categoritzem la distància entre l'atacant i el defensor el moment de realitzar el tir. Per a distàncies inferiors als 50cm considerem tenim un *Close Defensor (C)*, per distàncies superiors a 1 metre tenim *Far Defensor (F)* i entre mig tenim *Medium Defensor (M)*.

```{r}
data$CLOSE_DEF_DIST_C <- "M"
data$CLOSE_DEF_DIST_C[data$CLOSE_DEF_DIST < 0.5] <- "C"
data$CLOSE_DEF_DIST_C[data$CLOSE_DEF_DIST > 1] <- "F"
```

## 2.5 Creació de noves variables
### 2.5.1 Over Time
Creem una variable binària per identificar si els llençaments s'efectuen en la pròrroga. L'interès d'aquesta variable recau en que són moments de temps afegit i els cansament dels jugadors pot afectar en els resultats.
```{r}
data$OT <- ifelse(data$PERIOD > 4, 1, 0)
```

### 2.5.2. Clutch/Handicap
Considerem Handicap aquelles situacions de pressió, estàn relacionades amb els finals de partits quan el marcador està apretat, són aquells instants on cada llençament pot donar la victòria o la derrota de l'equip. Considerem que aquests instants poden afectar el comportament dels jugadors i la capactiat de llençament. Per això considerem moments de pressió el final de partit, últim minut de joc on la diferència de punts entre ambdós equipssigui inferior a 6 punts.
```{r}
data$CLUTCH <- ifelse(as.integer(data$PERIOD) >= 4 & data$GAME_CLOCK_MIN == 0  & abs(data$FINAL_MARGIN) < 6 ,1,0)
```

### 2.5.3 Attack Type
Creiem que la duracció de la jugada d'atac influeix en la capacitat anotadora dels atacants. Que la jugada pensada per l'equip funcioni bé o malament pot anar relacionat amb la durada de la jugada, a millors defensors més es tarda en trobar una ocasió clara de llençament. També, els llençaments apurats en últim moment de possessió seran en situacions poc comodes i afectar la precissió.
Si l'atac ha durat entre 0 i 12 segons és un atac curt, o jugada curta *short* i si està entre els 12 i 24 segons és una atac llarg *long*. 
```{r}
data$ATTACK_TYPE <- ifelse(data$SHOT_CLOCK < 12, "Short", "Long")
```

## 2.6 Guardar el Dataset
Hi ha diferents atributs presents en aquests conjunt de dades que no per nosaltres no tenen rellevància i no són útils amb el propòsit de l'estudi. La variable *MATCHUP* només ens aporta informació relativa al partit, i no considerem una dependència espai-temporal més enllà de si el jugador és local o visitant.

La *FINAL_MARGIN* o diferència de punts en el resultat final no ens aporta informació del marcador en cada instant del partit. L'equip que guanya el partit no té perquè ser el millor equip en cada moment del partit, per això la variable *W* tampoc ens aporta informació.

Tant el *player_name*, *player_id* com el *CLOSEST_DEFENDER*, *CLOSEST_DEFENDER_PLAYER_ID* és informació que no utilitzarem perquè no ens interesa estudiar el comportament dels jugadors com a individuos si no els resultats que tenen com a conjunts. Encanvi mantenirm el *GAME_ID* que defineix la granularitat dels nostres càlculs.

La variable *FMG* ens indica el mateix que la variable *SHOT_RESULT* respecta si ha fet o fallat el tir.

Tant la variable *PTS_TYPE* com la variable *PTS* ens indica si el llençament ha estat de 2 o 3 punts o fallat. Ja podem determinar quin tipus de llençament ha fet, 2 o 3 punts, per la distància de llençaemnt i no ens interessa saber que si és o no és un triple com si el tir entra o no.

Guardaem el DataSet preparat amb les columnes que volem
```{r}
rows <- c("GAME_ID", "LOCATION","PERIOD","OT","ATTACK_TYPE",
          "SHOT_DIST","SHOT_DIST_C","CLOSE_DEF_DIST","CLOSE_DEF_DIST_C",
          "TOUCH_TIME","PTS_TYPE","SHOT_RESULT","CLUTCH")
df_nba <- data[, rows]
write.csv(df_nba, file = "data_nba.csv")
```

# 3 Anàlisis de les dades

Volem analitzar les nostres dades per tal de determinar quins aspectes influencien que encertem o fallem un llençament. D'aquesta manera poder realitzar un model per donades unes condicions de llençament, predir si aquest es falla o no. Així podem determinar quines són les situacions de més èxit.

El primer pas és importar el dataset netejat que hem preparat anteriorment:
```{r}
df<- read_csv("data_nba.csv")
df$X1 <- NULL
df$ATTACK_TYPE <- as.factor(df$ATTACK_TYPE)
df$CLOSE_DEF_DIST_C <- factor(df$CLOSE_DEF_DIST_C, levels = c("C","M","F"))
df$PTS_TYPE <- as.factor(df$PTS_TYPE)
df$SHOT_RESULT <- as.factor(df$SHOT_RESULT)
```

## 3.1 L'efecte de la distància en el llençament
Volem realitzar l'estudi de la semblança de les variables enfocat cap quines variables són les que més influirien en la possible predicció de si un tir X serà encistellar o no.

### 3.1.1 Preparació conjunt
El primer pas serà veure com afecta la distància de llençament en la precisió. El primer pas és calcular la pressisió tir per partit, segons la distància de llençament:
```{r}
data_sdc <- df %>% group_by(GAME_ID, SHOT_DIST_C, SHOT_RESULT)
df_sdc <- inner_join(data_sdc %>% filter(SHOT_RESULT == "made") %>% 
                       summarise(TR = n()),
                      data_sdc %>% filter(SHOT_RESULT == "missed") %>% 
                       summarise(TF = n()),
                      by = c("GAME_ID","SHOT_DIST_C"), copy = TRUE)
df_sdc <- subset(df_sdc, select = -c(SHOT_RESULT.x, SHOT_RESULT.y))
df_sdc$SHOT_DIST_C <- factor(df_sdc$SHOT_DIST_C, levels = c("C","M","F"))
df_sdc$TI <- df_sdc$TR + df_sdc$TF
df_sdc$PRES <- 100*df_sdc$TR/df_sdc$TI
```

### 3.1.2 Visualització
Visualitzem a continuació (mitjançant un boxplot i un histograma) la precisió en funció dels tres valors categòrics de l'atribut distància de llençament per veure a ull si hi pot haver una relació directa entre aquestes variables i poder veure també com aquestes estan distribuïdes:
```{r}
ggplot(df_sdc, aes(x = SHOT_DIST_C, y = PRES ,fill = SHOT_DIST_C)) +
  geom_boxplot()+ggtitle("Precission by Shot Dist")
ggplot(df_sdc,aes(x=PRES,group=SHOT_DIST_C, fill=SHOT_DIST_C))+
  geom_histogram(position="identity",
                 aes(y=..density..),
                 alpha=0.75,
                 binwidth = 5) + 
  xlab("% Encert")+ylab("Densitat")+ggtitle("Histogram SHOT_DIST_C BY PRECISION")
```
Tant en el boxplot com en l'histograma veiem diferents distribucions per a la precisió de tir segons la distància de llençament. Per tant, podem veure que les distribucions en cap cas seran iguals i podem començar a pensar que l'atribut distància de tir, serà un dels atributs més influents.
A més, a continuació podem veure els valors promig i la seva desviació:

```{r}
mu <- plyr::ddply(df_sdc, "SHOT_DIST_C", summarise, pres.mean=mean(PRES), pres.sd =sd(PRES))
mu
```
Veiem que efectivament, tal i com esperàvem, pels tirs realitzats des de més a prop (SHOT_DIST_C = C), la precisió augmenta considerablement en comparació amb la resta de variables i la desviació estàndard també resulta ser molt més baixa en relació.

### 3.1.3 Comprovació normalitat.
Ara ens centrarem en comparar la baixada de pressisió amb l'augment de la distància. Primer comprovarem si cada atribut segueix una distribució normal.
#### 3.1.3.1. Q-Q Plot
Representem les variables en un Q-Q Plot per mirar d'identificar si tenen una distribució normals:
```{r}
par(mfrow=c(1,3))
qqnorm(df_sdc$PRES[df_sdc$SHOT_DIST_C == "C"], main = "CLOSE")
qqline(df_sdc$PRES[df_sdc$SHOT_DIST_C == "C"])
qqnorm(df_sdc$PRES[df_sdc$SHOT_DIST_C == "M"], main = "MEDIUM")
qqline(df_sdc$PRES[df_sdc$SHOT_DIST_C == "M"])
qqnorm(df_sdc$PRES[df_sdc$SHOT_DIST_C == "F"], main = "FAR")
qqline(df_sdc$PRES[df_sdc$SHOT_DIST_C == "F"])
```
Els Q-Q plots són prou satisfactòris com per confirmar la normalitat de les dades.

#### 3.1.3.2 Test de Kolmogorov-Smirnov
Per donar suport als Q-Q Plots realitzem la prova de Kolmogorov-Smirnov per determinar si les disteribucions obtingudes per a les diferents distàncies responen a una distribució normal:
```{r}
ks.test(x = df_sdc$PRES[df_sdc$SHOT_DIST_C == "C"], y = "pnorm", alternative = "two.sided")
ks.test(x = df_sdc$PRES[df_sdc$SHOT_DIST_C == "M"], y = "pnorm", alternative = "two.sided")
ks.test(x = df_sdc$PRES[df_sdc$SHOT_DIST_C == "F"], y = "pnorm", alternative = "two.sided")
```
Veient els valors del p-value i sense cap mena de dubte podem confirmar que que les distribucions de la pressissió en funció de la distància de tir és normal.

### 3.1.4 Comprovació Hipòtesis
 A continuació farem un t-test (donada la normalitat de les dades) per determinar si hi ha diferències en l'efectivitat de llençament segons la distància. La nostra hipòtesis nul·la és la no diferència entre els tirs llunyans i propers, i la hipòtesis alternativa és que a menor distància més facil és encistellar i major precissió. Demanem el resultat amb un nivell de confiança del 95%.
```{r}
t.test(x = df_sdc$PRES[df_sdc$SHOT_DIST_C == "C"],
            y = df_sdc$PRES[df_sdc$SHOT_DIST_C == "F"], conf.level = 0.95)
```
Hem pogut veure que hem obtingut un p-value < 0.05, en aquest sentit, la hipòtesi nul·la queda descartada i veiem que les distribucions de la variable precisió varia en funció de si el llençament és proper o llunyà i podem veure que amb un valor p-value<<<0.5, serà una de les variables que més influirà en la possible predicció de si un tir X serà realitzat o no.


## 3.2 L'efecte del temps de possessió

Un cop hem estudiat la variable SHOT_DIST_C enfocarem l'estudi cap a la variable "TOUCH_TIME".
Primerament plotejarem el boxplot i els histogrames de la variable TOUCH_TIME en funció de si el tir ha estat encistellat o no, per veure a ull si les distribucions podrien arribar a ser semblants.
```{r}
ggplot(df, aes(x = SHOT_RESULT, y = TOUCH_TIME ,fill = SHOT_RESULT)) +
  geom_boxplot()+ggtitle("Resultat del tir by Touch time")
par(mfrow=c(1,3))
hist(df$TOUCH_TIME, freq = FALSE, col = "green",
     main = 'TOUCH_TIME', xlab = "Touch Time")
hist(df$TOUCH_TIME[df$SHOT_RESULT == "missed"], freq = FALSE, col = "blue",
     main = 'TOUCH_TIME & Missed Shoot', xlab = "Touch Time")
hist(df$TOUCH_TIME[df$SHOT_RESULT== "made"], freq = FALSE, col = "red",
     main = 'TOUCH_TIME & Made Shoot', xlab = "Touch Time")
```
Podem veure a simple vista mitjantçant el boxplot i els histogrames, que les distribucions tenen una forma força semblant, però no segueixen una distribució normal. 
Anem ara a comprovar mitjançant un Q-Q plot com realment les distribucions no es corresponen a una normal:
```{r}
par(mfrow=c(1,2))
qqnorm(df$TOUCH_TIME[df$SHOT_RESULT == "missed"], main = "MISSED")
qqline(df$TOUCH_TIME[df$SHOT_RESULT == "missed"])
qqnorm(df$TOUCH_TIME[df$SHOT_RESULT== "made"], main = "MADE")
qqline(df$TOUCH_TIME[df$SHOT_RESULT== "made"])
```
Veiem com efectivament, les distribucions no es corresponen amb una distribució normal.

D'aquesta forma, per poder comprovar les diferències entre la variable TOUCH_TIME en funció de si el tir és encistellat o no aplicarem un test de wilcoxon (mitjançant la suposició del teorema del límit central, ja que disposem d'una mostra d'instàncies suficientment gran):
```{r}
wilcox.test(x = df$TOUCH_TIME[df$SHOT_RESULT == "missed"],
            y = df$TOUCH_TIME[df$SHOT_RESULT== "made"], alternative = "less", conf.level = 0.95)
mu1 <- plyr::ddply(df, "SHOT_RESULT", summarise, touch.mean=mean(TOUCH_TIME), touch.sd =sd(TOUCH_TIME))
mu1
```
Veiem doncs que finalment amb un valor p-value <<< 0.5  i veiem que les dues distribucions segueixen un comportament força diferent, però si ens fixem amb els valors de les mitjanes i la desviació estàndard veiem que les dues distribucions haurien de ser força iguals. 
Aquesta discrepància podria venir donada per la diferenciació en els valors extrems de les dues poblacions mostrals tal i com hem pogut veure en els Q-Q plots i en els boxplot i histogrames. Per tant, veiem que aquesta variable no serà una de les que més ens podran influir en si un tir podrà acabar sent encistellat o no. 
A més a més, caldria comentar, que aquest resultat podia ser d'esperar, ja que el temps de possessió de la pilota d'un jugador de l'equip, no hauria de ser un atribut molt influent en la qualitat del seu tir posterior. Per tant, cada cop estem veient que les variables que més podran acabar influint són les que es centren únicament en el moment del tir i no en instants anteriors.

## 3.3 CLUTCH:
Seguidament, estudiarem la possible relació entre la precisió dels tirs i l'atribut CLUTCH. Aquest atribut el calcularem mitjançant la suma de moments CLUTCH que hi ha hagut durant el partit en cada una de les 3 distàncies de llençament C, M, F.
Crearem un subdataset on poder estudiar aquesta variable en funció del la distància mitjana dels 3 tipus de distància de tirs de cada partit i en funció de la precisió.

```{r}
data_sdc <- df %>% group_by(GAME_ID, SHOT_DIST_C, SHOT_RESULT)
df_sdc <- inner_join(data_sdc %>% filter(SHOT_RESULT == "made") %>% 
                       summarise(TR = n(), Dist_R = mean(SHOT_DIST),
                                                               Def_R = mean(CLOSE_DEF_DIST)),
                      data_sdc %>% filter(SHOT_RESULT == "missed") %>% 
                       summarise(TF = n(), Dist_F = mean(SHOT_DIST),
                                                               Def_F = mean(CLOSE_DEF_DIST)),
                      by = c("GAME_ID", "SHOT_DIST_C"), copy = TRUE)
df_sdc <- inner_join(df_sdc,
                     data_sdc %>% summarize(CLUTCH=sum(CLUTCH)))
df_sdc <- subset(df_sdc, select = -c(SHOT_RESULT.x, SHOT_RESULT.y))
df_sdc$SHOT_DIST_C <- factor(df_sdc$SHOT_DIST_C, levels = c("C","M","F"))
df_sdc$TI <- df_sdc$TR + df_sdc$TF
df_sdc$PRES <- 100*df_sdc$TR/df_sdc$TI
```

### 3.3.1 Visualtizació de les dades:
Començarem plotejant els histogrames de la variable CLUTCH en funció de la precisió:
```{r}
par(mfrow=c(1,3))
hist(df_sdc$PRES, freq = FALSE, col = "green",
     main = "Precisió", xlab = "% Precisió")
hist(df_sdc$PRES[df_sdc$CLUTCH==0], freq = FALSE, col = "blue",
     main = "Precisió & NO Clutch", xlab = "% Precisió")
hist(df_sdc$PRES[df_sdc$CLUTCH>0], freq = FALSE, col = "orange",
     main = "Precisió % Clutch", xlab = "% Precisió")
```
Veiem que els histogrames ens indiquen que aquesta variable segueix una distribució normal i que tant la distribució pel cas Precisió(CLUTCH) i pel cas Precisió(NO CLUTCH) són bastant semblants.

A continuació representarem els boxplots de la variable PRES en funció dels moments CLUTCH.
```{r}
ggplot(df_sdc, aes(x = CLUTCH, y = PRES ,fill = CLUTCH, group=CLUTCH)) +
  geom_boxplot()+ggtitle("Presicion dels tirs vs moment clutch de tirs")
```
Podem veure com les 6 distribucions plotejades tenen una forma bastant semblant i podem apreciar a simple vista, que no existeix una diferència de comportament entre la precisió en els moments clutch i els moments no clutch.

### 3.3.2 Comprovació normalitat.
Ara ens centrarem en comparar la baixada de pressisió amb l'augment de la distància. Primer comprovarem si cada atribut segueix una distribució normal.
#### 3.3.2.1 Q-Q Plot
Anem a comprovar aquesta suposada normalitat mitjançant un Q-Q Plot:
```{r}
par(mfrow=c(1,2))
qqnorm(df_sdc$PRES[df_sdc$CLUTCH>0], main = "CLUTCH")
qqline(df_sdc$PRES[df_sdc$CLUTCH >0])
qqnorm(df_sdc$PRES[df_sdc$CLUTCH==0], main = "NO CLUTCH")
qqline(df_sdc$PRES[df_sdc$CLUTCH==0])
```
Els Q-Q plots són prou satisfactòris com per confirmar la normalitat de les dades.

#### 3.3.2.2. Kolmogorov-Smirnov Test
Per donar suport als Q-Q Plots realitzem la prova de Kolmogorov-Smirnov per determinar si les disteribucions obtingudes per a les diferents distàncies responen a una distribució normal:
```{r}
ks.test(x = df_sdc$PRES[df_sdc$CLUTCH>0], y = "pnorm", alternative = "two.sided")
ks.test(x = df_sdc$PRES[df_sdc$CLUTCH==0], y = "pnorm", alternative = "two.sided")
```
Veient els valors del p-value i sense cap mena de dubte podem confirmar que que les distribucions de la pressissió en funció de la distància de tir és normal.

### 3.3.3 Comprovació Hipòtesis
Finalment, mitjançant un t test anem a comprovar la semblança entre les distribucions de les variables PRES(NO CLUTCH) i PRES(CLUTCH):
```{r}
t.test(x = df_sdc$PRES[df_sdc$CLUTCH==0], y = df_sdc$PRES[df_sdc$CLUTCH >0])
mean(df_sdc$PRES[df_sdc$CLUTCH==0])
sd(df_sdc$PRES[df_sdc$CLUTCH==0])
mean(df_sdc$PRES[df_sdc$CLUTCH >0])
sd(df_sdc$PRES[df_sdc$CLUTCH >0])
```
Veiem doncs que les dues distribucions tenen un comportament molt similar i podem afirmar que la variable clutch no jugarà un paper massa important en la predicció d'encistellament del tir.
Aquest fet corrobora la idea de que, tenint en compte que estem tractant amb professionals de la NBA, el moment previ al tir, o la pressió que envolta el moment del tir (CLUTCH) no els influeix massa en el simple fet d'encistellar o no.

Finalment, per acabar de comprovar si la variable CLUTCH juga un paper força secundari, comprovarem si la distància promig dels tirs (tant si són encistellats (DIST_R) o no encistellats (DIST_F)) influeix o no si es tracta d'un moment de pressió:
```{r}
"DIST_R:"
wilcox.test(x = df_sdc$Dist_R[df_sdc$CLUTCH>0], y = df_sdc$Dist_R[df_sdc$CLUTCH==0])
median(df_sdc$Dist_R[df_sdc$CLUTCH>0])
sd(df_sdc$Dist_R[df_sdc$CLUTCH>0])
median(df_sdc$Dist_R[df_sdc$CLUTCH==0])
sd(df_sdc$Dist_R[df_sdc$CLUTCH==0])
"DIST_F:"
wilcox.test(x = df_sdc$Dist_F[df_sdc$CLUTCH>0], y = df_sdc$Dist_F[df_sdc$CLUTCH==0])
median(df_sdc$Dist_F[df_sdc$CLUTCH>0])
sd(df_sdc$Dist_F[df_sdc$CLUTCH>0])
median(df_sdc$Dist_F[df_sdc$CLUTCH==0])
sd(df_sdc$Dist_F[df_sdc$CLUTCH==0])
```
Veiem doncs com el resultat del p-value ens indica que la hipòtesi nul·la no pot ser rebutjada, i per tant, veiem que les distribucions de precisió en els moments clutch i els moments no clutch és semblant.
Per tant, podem descartar finalment la variable CLUTCH com una variable influent en la predicció de llençament i ens centrarem en les variables físiques que influeixen en el precís moment del tir: SHOT_DIST i CLOSE_DEF_DIST.

## 3.4 Distància defensor més proper:
El següent pas serà veure com afecta la distància a la que es troba el defensor en el moment del llençament en la precisió dels tirs. El primer pas és calcular la precisió tir per partit, segons la distància a la que es troba el defensor en el moment del llençament:
```{r}
data_sdc <- df %>% group_by(GAME_ID, CLOSE_DEF_DIST_C, SHOT_RESULT)
df_sdc <- inner_join(data_sdc %>% filter(SHOT_RESULT == "made") %>% 
                       summarise(TR = n()),
                      data_sdc %>% filter(SHOT_RESULT == "missed") %>% 
                       summarise(TF = n()),
                      by = c("GAME_ID","CLOSE_DEF_DIST_C"), copy = TRUE)
df_sdc <- subset(df_sdc, select = -c(SHOT_RESULT.x, SHOT_RESULT.y))
df_sdc$CLOSE_DEF_DIST_C <- factor(df_sdc$CLOSE_DEF_DIST_C, levels = c("C","M","F"))
df_sdc$TI <- df_sdc$TR + df_sdc$TF
df_sdc$PRES <- 100*df_sdc$TR/df_sdc$TI
```

### 3.4.1 Visualització
Visualitzem a continuació (mitjançant un boxplot i un histograma) la precisió en funció dels tres valors categòrics de l'atribut distància del defensor en el moment del llençament per veure a ull si hi pot haver una relació directa entre aquestes variables i poder veure també com aquestes estan distribuïdes:
```{r}
ggplot(df_sdc, aes(x = CLOSE_DEF_DIST_C, y = PRES ,fill = CLOSE_DEF_DIST_C)) +
  geom_boxplot()+ggtitle("Precission by Shot Dist")
ggplot(df_sdc,aes(x=PRES,group=CLOSE_DEF_DIST_C, fill=CLOSE_DEF_DIST_C))+
  geom_histogram(position="identity",
                 aes(y=..density..),
                 alpha=0.75,
                 binwidth = 5) + 
  xlab("% Encert")+ylab("Densitat")+ggtitle("Histogram CLOSE_DEF_DIST_C BY PRECISION")
```
Tant en el boxplot com en l'histograma veiem diferents distribucions per a la precisió de tir segons la distància del defensor en el moment del llençament. Per tant, podem veure que les distribucions en cap cas seran iguals i podem començar a pensar que l'atribut distància de tir, serà un dels atributs més influents.
A més, a continuació podem veure els valors promig i la seva desviació:

```{r}
mu <- plyr::ddply(df_sdc, "CLOSE_DEF_DIST_C", summarise, pres.mean=mean(PRES), pres.sd =sd(PRES))
mu
```
Veiem que efectivament, tal i com esperàvem, pels tirs realitzats amb el defensor més a prop (CLOSE_DEF_DIST_C = C), distància inferior a 50 cm la precisió baixa en comparació amb si el defensor es troba situat entre 50 i 100 cm (tot i que amb una desviació estàndar aproximadament de 12.5), però en canvi, veiem que la precisió quan el defensor es troba més enllà de 100cm disminueix, a l'igual que la seva desviació. 
Aquest fet pot ser provocat pel fet que estem estudiant totes els tirs possibles que hi ha durant un partit com si es tractessin de tirs convencionals durant una possessió de pilota convencional i no estem tenint en compte tampoc la distància a la que estem tirant, ja que podria ser que tenim el defensor a una distància < 50cm, però estem tirant tota l'estona des d'una distància SHOT_DIST_C=C.

### 3.4.2 Comprovació normalitat.
Ara ens centrarem en comparar la baixada de pressisió amb l'augment de la distància. Primer comprovarem si cada atribut segueix una distribució normal.
#### 3.4.2.1. Q-Q Plot
Representem les variables en un Q-Q Plot per mirar d'identificar si tenen una distribució normals:
```{r}
par(mfrow=c(1,3))
qqnorm(df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "C"], main = "CLOSE")
qqline(df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "C"])
qqnorm(df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "M"], main = "MEDIUM")
qqline(df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "M"])
qqnorm(df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "F"], main = "FAR")
qqline(df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "F"])
```
Els Q-Q plots són prou satisfactòris com per confirmar la normalitat de les dades.

#### 3.4.2.2 Test de Kolmogorov-Smirnov
Per donar suport als Q-Q Plots realitzem la prova de Kolmogorov-Smirnov per determinar si les disteribucions obtingudes per a les diferents distàncies responen a una distribució normal:
```{r}
ks.test(x = df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "C"], y = "pnorm", alternative = "two.sided")
ks.test(x = df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "M"], y = "pnorm", alternative = "two.sided")
ks.test(x = df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "F"], y = "pnorm", alternative = "two.sided")
```
Veient els valors del p-value i sense cap mena de dubte podem confirmar que que les distribucions de la pressissió en funció de la distància de tir és normal.

### 3.4.3 Comprovació Hipòtesis
 A continuació farem un t-test (donada la normalitat de les dades) per determinar si hi ha diferències en l'efectivitat de llençament segons la distància. La nostra hipòtesis nul·la és la no diferència entre els tirs llunyans i propers, i la hipòtesis alternativa és que a menor distància més facil és encistellar i major precissió. Demanem el resultat amb un nivell de confiança del 95%.
```{r}
t.test(x = df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "C"],
            y = df_sdc$PRES[df_sdc$CLOSE_DEF_DIST_C == "F"], conf.level = 0.95)
```
Hem pogut veure que hem obtingut un p-value < 0.05, en aquest sentit, la hipòtesi nul·la queda descartada i veiem que les distribucions de la variable precisió varia en funció de si el desfensor es troba proper o llunyà. 
D'altra banda, i tal i com hem explicat anteriorment, el fet que el p-value no sigui molt més inferior a 0.05 del que ho és pot venir donat per la exclusió dels paràmetres independents dels que depen l'atribut CLOSE_DEF_DIST, com ara el tipus d'atac o la distància des de la que estem tirant.
Tot i tenir això en compte, l'atribut CLOSE_DEF_DIST serà una de les variables que influirà en la possible predicció de si un tir X serà realitzat o no.

## 3.5 ATTACK TYPE:
Seguidament, estudiarem la possible relació entre la precisió dels tirs i l'atribut ATTACK_TYPE, que depen del temps de partit corregut abans del moment del tir. 
Crearem un subdataset on poder estudiar aquesta variable en funció de la precisió dels tirs realitzats i fallats:
```{r}
data_atta <- df %>% group_by(GAME_ID, ATTACK_TYPE, SHOT_RESULT)
data_atta$ATTACK_TYPE <- ifelse(data_atta$ATTACK_TYPE == "Short", 0, 1)
df_atta_0 <- inner_join(data_atta %>% filter(SHOT_RESULT == "made" & ATTACK_TYPE == 0) %>% 
                       summarise(TR = n()),
                      data_atta %>% filter(SHOT_RESULT == "missed" & ATTACK_TYPE == 0) %>% 
                       summarise(TF = n()),
                      by = c("GAME_ID","ATTACK_TYPE"), copy = TRUE)
df_atta_1 <- inner_join(data_atta %>% filter(SHOT_RESULT == "made" & ATTACK_TYPE == 1) %>% 
                       summarise(TR = n()),
                      data_atta %>% filter(SHOT_RESULT == "missed" & ATTACK_TYPE == 1) %>% 
                       summarise(TF = n()),
                      by = c("GAME_ID","ATTACK_TYPE"), copy = TRUE)
df_atta_0 <- subset(df_atta_0, select = -c(SHOT_RESULT.x, SHOT_RESULT.y))
df_atta_1 <- subset(df_atta_1, select = -c(SHOT_RESULT.x, SHOT_RESULT.y))
df_atta <- union(x = df_atta_0, y = df_atta_1)
df_atta$ATTACK_TYPE <- as.factor(df_atta$ATTACK_TYPE)
df_atta$TI <- df_atta$TR + df_atta$TF
df_atta$PRES <- 100*df_atta$TR/df_atta$TI
```

### 3.5.1 Visualització de les dades
Començarem visualitzant les dades creades en el subdataset anterior (df_atta) on tenim l'atribut ATTACK_TYPE en funció de la precisió dels tirs:

```{r}
ggplot(df_atta, aes(x = ATTACK_TYPE, y = PRES ,fill = ATTACK_TYPE)) +
  geom_boxplot()+ggtitle("Precission by Attack Type")
par (mfrow = c(1,2))
hist(df_atta$PRES[df_atta$ATTACK_TYPE == 0], freq = FALSE, breaks = 8,
     main = "SHORT ATTACK", xlab = "Precisió", col = "red", ylim = c(0,0.1))
hist(df_atta$PRES[df_atta$ATTACK_TYPE == 1], freq = FALSE, breaks = 8,
     main = "LONG ATTACK", xlab = "Precisió", col = "lightblue", ylim = c(0,0.1))
ggplot(df_atta,aes(x=PRES,group=ATTACK_TYPE, fill=ATTACK_TYPE))+
  geom_histogram(position="identity",
                 aes(y=..density..),
                 alpha=0.75,
                 binwidth = 12.5) + 
  xlab("% Encert")+ylab("Densitat")+ggtitle("Histogram ATTACK_TYPE BY PRECISION")
```
### 3.5.2 Comprovació normalitat.
Ara ens centrarem en comparar la baixada de pressisió amb el tipus d'atac. Primer comprovarem si cada atribut segueix una distribució normal.
#### 3.5.2.1. Q-Q Plot:
Anem a comprovar aquesta suposada normalitat mitjançant un Q-Q Plot:
```{r}
par(mfrow=c(1,2))
qqnorm(df_atta$PRES[df_atta$ATTACK_TYPE==1], main = "LONG ATTACK")
qqline(df_atta$PRES[df_atta$ATTACK_TYPE==1])
qqnorm(df_atta$PRES[df_atta$ATTACK_TYPE==0], main = "SHORT ATTACK")
qqline(df_atta$PRES[df_atta$ATTACK_TYPE==0])
```
Els Q-Q plots són prou satisfactòris com per confirmar la normalitat de les dades.

#### 3.5.2.1. Kolmogorov-Smirnov Test:
Per donar suport als Q-Q Plots realitzem la prova de Kolmogorov-Smirnov per determinar si les disteribucions obtingudes per a les diferents distàncies responen a una distribució normal:
```{r}
ks.test(x = df_atta$PRES[df_atta$ATTACK_TYPE==1], y = "pnorm", alternative = "two.sided")
ks.test(x = df_atta$PRES[df_atta$ATTACK_TYPE==0], y = "pnorm", alternative = "two.sided")
```
Veient els valors del p-value i sense cap mena de dubte podem confirmar que que les distribucions de la precisió en funció de la distància de tir és normal.

### 3.5.3 Comprovació Hipòtesis
Finalment, mitjançant un t test anem a comprovar la semblança entre les distribucions de les variables PRES(ATTACK_TYPE=CURT(0)) i PRES(ATTACK_TYPE=LLARG(1)):
```{r}
t.test(x = df_atta$PRES[df_atta$ATTACK_TYPE==0], y = df_atta$PRES[df_atta$ATTACK_TYPE==1])
mean(df_atta$PRES[df_atta$ATTACK_TYPE==1])
sd(df_atta$PRES[df_atta$ATTACK_TYPE==1])
mean(df_atta$PRES[df_atta$ATTACK_TYPE==0])
sd(df_atta$PRES[df_atta$ATTACK_TYPE==0])
```
Hem obtingut un p-value <<< 0.5 cosa que ens indica que la hipòtesi nul·la queda descartada i veiem que les distribucions de la variable precisió varia en funció de si l'atac és curt o llarg en temps de possessió de la pilota. 
Caldrà tenir doncs en compte aquest atribut a l'hora de realitzar la predicció d'encert del tir, ja que si la precisió difereix molt en funció de si l'atac és llarg o curt, pot voler dir que la probabilitat d'encert d'un tir dependrà de si l'atac previ és curt o llarg. 
D'altra banda, cal recordar que al ser un atribut que categoritza instants previs al tir no podrà arribar a dependre mai tant com els atributs precisos del moment del tir.


# 4 Predicció llençament:
Un cop hem investigat les possibles variables que poden influir en la predicció del llençament, anem a generar un model per predir l'encert o no encert del llençament.

## 4.1 Creació del models:
Començarem per crear un model molt senzill del que anirem augmentant la complexitat.

En els models que anirem creant, les variables que intervindran són la distància de llençament, la distància al defensor més proper i el tipus d'atac.

### Relevel Variables:
A partir de les variables categòriques esteblim nivells de referència per generar un model. D'aquesta manera la presència o no d'una variable portarà un valor diferent.
```{r}
df$CLUTCH <- as.factor(df$CLUTCH)
df$OT <- as.factor(df$OT)
df$CLUTCH_L <- relevel(df$CLUTCH, ref = "0")
df$ATTACK_TYPE_L <- relevel(df$ATTACK_TYPE, ref = "Long")
df$CLOSE_DEF_DIST_L <- relevel(df$CLOSE_DEF_DIST_C, ref = "C")
df$SHOT_DIST_L <- relevel(as.factor(df$SHOT_DIST_C), ref = "C")
```

### 4.1.1 Model 1:
Començem pel model 1 on únicament tenim en compte la distància del tir:
```{r}
model_1 <- glm(SHOT_RESULT ~ SHOT_DIST,
            data = df,
            family = "binomial")
```

### 4.1.2 Model 2:
En aquest segon model només tenim en compte les variables categòriques de la distància de llençament i distància del defensor:
```{r}
model_2 <- glm(SHOT_RESULT ~ SHOT_DIST_L + CLOSE_DEF_DIST_L,
            data = df,
            family = "binomial")
```

### 4.1.3 Model 3:
Finalitzem l'estudi de models creant un model que incorpori les variables analitzades anteriorment, així com el clutch, el touch time o l'attack type:
```{r}
model_3 <- glm(SHOT_RESULT ~ SHOT_DIST + CLOSE_DEF_DIST + TOUCH_TIME  + CLUTCH_L + ATTACK_TYPE_L,
            data = df,
            family = "binomial")
```


## 4.2 Prediccions models:
Fem una predicció pels tres models diferents sobre el mateix conjunt de dades que s'han entrenat.
```{r}
df$SHOT_RESULT_pred_1 <- predict.glm(model_1, df, type = "response")
df$SHOT_RESULT_pred_2 <- predict.glm(model_2, df, type = "response")
df$SHOT_RESULT_pred_3 <- predict.glm(model_3, df, type = "response")
```

## 4.3 Anàlisi models:
Creem la corba ROC dels 3 models per veure la seva efectivitat:
```{r}
library(pROC)
roc_1 <- roc(response = df$SHOT_RESULT, 
                predictor = df$SHOT_RESULT_pred_1, plot = FALSE)
roc_2 <- roc(response = df$SHOT_RESULT, 
                predictor = df$SHOT_RESULT_pred_2, plot = FALSE)
roc_3 <- roc(response = df$SHOT_RESULT, 
                predictor = df$SHOT_RESULT_pred_3, plot = FALSE)
```

I finalment plotejem les corbes ROC dels 3 models en un mateix gràfic per fer més senzilla la comparació d'efectivitat:
```{r}
plot(roc_1, add = FALSE, col = 'red',
     asp = .5, xlim = c(1,0),  ylim = c(0,1),
     print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.5)
legend(x = 0.30, y = 0.65, legend = 'Model 1',
       col = 'red', lty = 1, bty = 'n')
plot(roc_2, add = TRUE, col = 'blue',
     asp = .5, xlim = c(1,0),  ylim = c(0,1),
     print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.3)
legend(x = 0.30, y = 0.45, legend = 'Model 2',
       col = 'blue', lty = 1, bty = 'n')
plot(roc_3, add = TRUE, col = 'green',
     asp = .5, xlim = c(1,0),  ylim = c(0,1),
     print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.1)
legend(x = 0.30, y = 0.25, legend = 'Model 3',
       col = 'green', lty = 1, bty = 'n')
```

Gràcies als gràfics de les corbes ROC i el valor del AUC podem determinar que la distància a la canasta a l'hora de llençar és el factor més important de tots. Haurem de buscar altres parametres perquè els actuals no millore molt més el model.

# Conclusions:

L'objectiu de l'anàlisi d'aquest conjunt de dades tenia la finalitat de determinar aquells atributs que més influencien el llençament. El primer fet observat ha estat la importància de la distància a canasta, observem una baixada important de la precisió quan passem de distàncies curtes a llargues. De la mateixa manera, i com és lògic, trobem que quan més lluny es troba el defensor més fàcil és anotar. També hem trobat com el temps de possessió previ al llençament, la durada de l'atac o si ens trobem en un moment de pressió (CLUTCH) tots ells afecten amb més o menys mesura a la capacitat anotadora del tirador. En aquest sentit, hem vist que els atributs que més afectaven a la possible predicció eren els que únicament estaven relacionats amb el moment de tir en sí (SHOT_DIST i CLOSE_DEF_DIST). Aquest fet podria arribar a explicar-se tenint en compte que estem tractant amb jugadors professionals entrenats per a que les condicions exteriors i condicions prèvies als moments de tir els influeixin el menys possible.

Durant la realització dels models de predicció hem aplicat tots els coneixements previs comentats. El primer de tots els models i el més senzill únicament té en compte la distància de tir i ens demostra que és l'atribut més important. Seguidament provem un model categòric on incorporem les variables categòriques de la distància de llençament i distància del defensor. És sorprenent veure com la diferència en la AUC del primer i segon model difereixen tant poc. L'últim model és el més complex i aquell que incorpora les variables estudiades en aquest projecte i presenta una AUC lleugerament superior als anteriors models.

Concoloem aquest treball considerant que faltaria un estudi molt més profund del dataset per trobar noves variables que puguin ajudar a la predicció. Potser s'haurien de tenir en compte atributs corresponents als jugadors ja sigui a quina posició juguen o mesures físiques com l'alçada o l'edat. Queda pendent per un anàlisi posterior tenir en compte aquests altres atributs així com algun que valori la dificultat intrínseca del llençament. Tot i això estem contents amb els resultats i conclusions obtingudes.

# 5 Taula Contribucions
Finalment, afegim al document la taula de contribucions demanada:
```{r echo = FALSE}
df<-data.frame("Investigacio Previa","Aleix Martinez Bages","Ignasi Vilarasau Antolin")
names(df)<-c("Contribuciones","Firma_1", "Firma_2")
de<-data.frame("Redaccio de les respostes","Aleix Martinez Bages","Ignasi Vilarasau Antolin")
names(de)<-c("Contribuciones","Firma_1", "Firma_2")
dr<-data.frame("Desenvolupament codi","Aleix Martinez Bages","Ignasi Vilarasau Antolin")
names(dr)<-c("Contribuciones","Firma_1", "Firma_2")
newdf <- rbind(df, de)
taula_de_contribucions <- rbind(newdf, dr)
taula_de_contribucions
```
